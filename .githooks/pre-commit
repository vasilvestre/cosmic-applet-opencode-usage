#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-3.0-only
#
# Pre-commit hook to enforce code quality standards
# This hook runs formatting and linting checks before allowing commits

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo "âŒ Error: cargo not found in PATH"
    exit 1
fi

# Check if nightly toolchain is available for rustfmt
if ! cargo +nightly --version &> /dev/null; then
    echo "âš ï¸  Warning: nightly toolchain not found, attempting to install..."
    rustup toolchain install nightly
fi

# 1. Run rustfmt check
echo "ğŸ“ Checking code formatting..."
if ! cargo +nightly fmt --all -- --check; then
    echo ""
    echo "âŒ Formatting check failed!"
    echo "ğŸ’¡ Run 'cargo +nightly fmt --all' to fix formatting issues"
    exit 1
fi
echo "âœ… Formatting check passed"

# 2. Run clippy with pedantic warnings
echo "ğŸ” Running clippy lints..."
if ! cargo clippy --all-features --all-targets -- -W clippy::pedantic -D warnings 2>&1 | tee /tmp/clippy-output.txt; then
    echo ""
    echo "âŒ Clippy check failed!"
    echo "ğŸ’¡ Fix the warnings/errors shown above before committing"
    exit 1
fi

# Check if there were any warnings (clippy with -D warnings treats them as errors)
if grep -q "warning:" /tmp/clippy-output.txt; then
    echo ""
    echo "âŒ Clippy warnings found!"
    echo "ğŸ’¡ Fix all clippy warnings before committing"
    rm -f /tmp/clippy-output.txt
    exit 1
fi

rm -f /tmp/clippy-output.txt
echo "âœ… Clippy check passed"

echo ""
echo "âœ… All pre-commit checks passed!"
echo "ğŸ“¦ Proceeding with commit..."
